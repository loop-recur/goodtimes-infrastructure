{
  "variables": {
    "aws_access_key": "",
    "aws_secret_key": "",
    "broker_id": "",
    "base_ami": ""
  },
  "builders": [{
    "type": "amazon-ebs",
    "access_key": "{{user `aws_access_key`}}",
    "secret_key": "{{user `aws_secret_key`}}",
    "region": "us-west-1",
    "source_ami": "ami-3549a971",
    "instance_type": "t2.small",
    "ssh_username": "ec2-user",
    "ami_name": "goodtimes {{timestamp}}",
    "ami_groups": ["all"]
  }],
  "provisioners": [{
    "type": "file",
    "source": "sources/keys/",
    "destination": "/tmp/"
  }, {
    "type": "shell",
    "inline": [
      "cp /tmp/deploy-* $HOME/.ssh"
    ]
  }, {
    "type": "shell",
    "inline": [
      "export HALCYON_AWS_ACCESS_KEY_ID={{user `aws_access_key`}}",
      "export HALCYON_AWS_SECRET_ACCESS_KEY={{user `aws_secret_key`}}",
      "export HALCYON_S3_ENDPOINT=s3-us-west-1.amazonaws.com",
      "export HALCYON_S3_BUCKET=goodtimes-builds",
      "eval `ssh-agent`",
      "sudo sh -c 'echo -e \"Host *\\n\\tStrictHostKeyChecking no\\n\" >> ~/.ssh/config'",
      "ssh-add $HOME/.ssh/deploy-scheduler",
      "sudo -E /app/halcyon/halcyon install git@github.com:loop-recur/goodtimes-scheduler.git",
      "ssh-add -D && ssh-add $HOME/.ssh/deploy-inquisitor",
      "sudo -E /app/halcyon/halcyon install git@github.com:loop-recur/goodtimes-inquisitor.git",
      "ssh-add -D && ssh-add $HOME/.ssh/deploy-wiggum",
      "sudo -E /app/halcyon/halcyon install git@github.com:loop-recur/goodtimes-wiggum.git",
      "sudo -E /app/halcyon/halcyon install https://github.com/begriffs/postgrest",
      "sudo sh -c 'echo -e \"#!/bin/sh\n/app/bin/goodtimes-scheduler\n\" > /etc/cron.daily/goodtimes-scheduler'",
      "sudo chmod a+x /etc/cron.daily/goodtimes-scheduler",
      "sudo sh -c 'echo \"/app/bin/goodtimes-inquisitor &\" >> /etc/rc.local'",
      "sudo sh -c 'echo \"/app/bin/goodtimes-wiggum &\" >> /etc/rc.local'",
      "sudo sh -c 'echo \"/app/bin/postgrest --db-host feelings.cmilwsejzmav.us-west-1.rds.amazonaws.com --db-port 5432 --db-name goodtimes --db-user feelmaster --db-pass 5YmV%XSilwhm%44HK#6* --db-pool 67 --anonymous feelmaster --port 8000 2>&1 | logger -t postgrest &\" >> /etc/rc.local'"
    ]
  }]
}
